{% extends "base.html" %}

{% block title %}{{ title }} - {{ super() }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">{{ title }} (Lot: <a href="{{ url_for('admin.view_lot_spots', lot_id=spot.parking_lot.id) }}">{{ spot.parking_lot.name }}</a>)</h1>
    <a href="{{ url_for('admin.view_lot_spots', lot_id=spot.parking_lot.id) }}" class="btn btn-sm btn-outline-info">Back to Lot Overview</a>
</div>

<div class="card">
    <div class="card-header">
        Spot Info
    </div>
    <div class="card-body">
        <p><strong>Spot Number:</strong> {{ spot.spot_number }}</p>
        <p><strong>Status:</strong> 
            {% if spot.status == 'Occupied' %}
                <span class="badge bg-danger">Occupied</span>
            {% elif spot.status == 'Available' %}
                <span class="badge bg-success">Available</span>
            {% elif spot.status == 'Reserved' %}
                <span class="badge bg-warning text-dark">Reserved</span>
            {% else %}
                <span class="badge bg-info">{{ spot.status }}</span> 
            {% endif %}
        </p>
        <p><strong>Parking Lot:</strong> <a href="{{ url_for('admin.view_lot_spots', lot_id=spot.parking_lot.id) }}">{{ spot.parking_lot.name }}</a></p>
        <p><strong>Price Per Hour for this Lot:</strong> ₹{{ "%.2f"|format(spot.parking_lot.price_per_hour) }}</p>

{# Checking for 'Occupied' status and the existence of an active reservation #}
{% if spot.status == 'Occupied' and reservation %}
    <div class="card mt-4">
        <div class="card-header">
            Current Reservation Details
        </div>
        <div class="card-body">
            <p><strong>Reserved By:</strong> {{ reservation.tenant.username }} (User ID: <a href="{{ url_for('admin.user_details', user_id=reservation.tenant.id) }}">{{ reservation.tenant.id }}</a>)</p>
            <p><strong>Full Name:</strong> {{ reservation.tenant.full_name }}</p>
            <p><strong>Email:</strong> {{ reservation.tenant.email }}</p>
            <p><strong>Parked At:</strong> {{ parked_at_ist_str }}</p>
            <p><strong>Current Time:</strong> {{ current_time_ist_str }}</p>
            <p><strong>Vehicle Number:</strong> {{ reservation.vehicle_number if reservation.vehicle_number else 'Not Provided' }}</p>
            <p><strong>Reservation Status:</strong> <span class="badge bg-success text-white">{{ reservation.status | title }}</span></p>
        </div>
    </div>
{% elif spot.status == 'Occupied' and not reservation %}
    <div class="alert alert-warning mt-4" role="alert">
        This spot is marked Occupied, but no active reservation record was found.
    </div>

{% elif spot.status == 'Reserved' and reservation %}
    <div class="card mt-4">
        <div class="card-header">
            Pending Reservation Details
        </div>
        <div class="card-body">
            <p><strong>Reserved By:</strong> {{ reservation.tenant.username }} (User ID: <a href="{{ url_for('admin.user_details', user_id=reservation.tenant.id) }}">{{ reservation.tenant.id }}</a>)</p>
            <p><strong>Full Name:</strong> {{ reservation.tenant.full_name }}</p>
            <p><strong>Email:</strong> {{ reservation.tenant.email }}</p>
            <p><strong>Booking Timestamp:</strong> {{ parked_at_ist_str }}</p> {# parked_at_ist_str holds booking_timestamp for active/pending #}
            <p><strong>Vehicle Number:</strong> {{ reservation.vehicle_number if reservation.vehicle_number else 'Not Provided' }}</p>
            <p><strong>Reservation Status:</strong> <span class="badge bg-warning text-dark">{{ reservation.status | title }}</span></p>
        </div>
    </div>

{% elif spot.status == 'Available' %}
    <br>
    <span class="alert alert-info mt-4" role="alert">
        This spot is currently available.
    </span>
{% endif %}

<h4 class="mt-5">Reservation History for this Spot</h4>
{% if reservations_history %}
    <table class="table table-sm table-hover mt-2">
        <thead>
            <tr>
                <th>User</th>
                <th>Vehicle</th>
                <th>Booked At</th> 
                <th>Check-in At</th> 
                <th>Check-out At</th> 
                <th>Status</th>
                <th>Total Cost</th> 
            </tr>
        </thead>
        <tbody>
            {% for res_hist in reservations_history %} 
                <tr>
                    <td>
                        {% if res_hist.tenant %} 
                            <a href="{{ url_for('admin.user_details', user_id=res_hist.tenant.id) }}">{{ res_hist.tenant.username }}</a> 
                        {% else %}
                            N/A (User Deleted)
                        {% endif %}
                    </td>
                    <td>{{ res_hist.vehicle_number if res_hist.vehicle_number else 'N/A' }}</td>
                    <td>{{ res_hist.booking_timestamp_ist_str }}</td>
                    <td>
                        {% if res_hist.check_in_timestamp_ist_str %}
                            {{ res_hist.check_in_timestamp_ist_str }}
                        {% else %}
                            <span class="text-muted">N/A</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if res_hist.check_out_timestamp_ist_str %}
                            {{ res_hist.check_out_timestamp_ist_str }}
                        {% else %}
                            <span class="text-muted">N/A</span> {# For active/pending #}
                        {% endif %}
                    </td>
                    <td>
                        {% if res_hist.status == 'active' %}
                            <span class="badge bg-success text-white">{{ res_hist.status | title }}</span>
                        {% elif res_hist.status == 'pending' %}
                            <span class="badge bg-warning text-dark">{{ res_hist.status | title }}</span>
                        {% elif res_hist.status == 'completed' %}
                            <span class="badge bg-info text-dark">{{ res_hist.status | title }}</span>
                        {% elif res_hist.status == 'cancelled' %}
                            <span class="badge bg-danger text-white">{{ res_hist.status | title }}</span>
                        {% else %}
                            <span class="badge bg-secondary text-white">{{ res_hist.status | title }}</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if res_hist.total_cost is not none %}
                            ₹{{ "%.2f"|format(res_hist.total_cost) }}
                        {% else %}
                            <span class="text-muted">N/A</span> {# For pending/active bookings #}
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
{% else %}
    <p>No reservation history for this spot.</p>
{% endif %}

{% endblock %}