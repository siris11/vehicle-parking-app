{% extends "base.html" %}

{% block title %}User Dashboard - {{ super() }}{% endblock %}

{% block head_css %}
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2 text-primary">Welcome, {{ current_user.full_name }}!</h1>
</div>

{% if current_user_reservation_detail %}
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">
            <h5 class="my-0 font-weight-normal">Your Current Reservation</h5>
        </div>
        <div class="card-body">
            <p><strong>Reservation ID:</strong> {{ current_user_reservation_detail.id }}</p>
            <p><strong>Parking Lot:</strong> {{ current_user_reservation_detail.parking_lot_name }}</p>
            <p><strong>Spot Number:</strong> {{ current_user_reservation_detail.spot_number }}</p>
            <p><strong>Vehicle Number:</strong> {{ current_user_reservation_detail.vehicle_number }}</p>
            <p><strong>Booked At:</strong> {{ current_user_reservation_detail.booking_timestamp_ist_str }}</p>
            {% if current_user_reservation_detail.check_in_timestamp_ist_str %}
                <p><strong>Check-in Time:</strong> {{ current_user_reservation_detail.check_in_timestamp_ist_str }}</p>
            {% endif %}
            <p><strong>Status:</strong> 
                {% if current_user_reservation_detail.status == 'pending' %}
                    <span class="badge bg-warning text-dark">{{ current_user_reservation_detail.status | title }}</span>
                {% elif current_user_reservation_detail.status == 'active' %}
                    <span class="badge bg-success">{{ current_user_reservation_detail.status | title }}</span>
                {% endif %}
            </p>
            <div class="mt-3">
                {% if current_user_reservation_detail.status == 'pending' %}
                    <form action="{{ url_for('user.check_in_reservation', reservation_id=current_user_reservation_detail.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Are you sure you want to check in this spot ?!')">
                        <button type="submit" class="btn btn-success me-2">Check In Now</button>
                    </form>
                    <form action="{{ url_for('user.cancel_reservation', reservation_id=current_user_reservation_detail.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Are you sure you want to cancel this reservation?');">
                        <button type="submit" class="btn btn-danger">Cancel Reservation</button>
                    </form>
                {% elif current_user_reservation_detail.status == 'active' %}
                    <a href="{{ url_for('user.park_out_page', reservation_id=current_user_reservation_detail.id) }}" class="btn btn-primary">Park Out</a>
                {% endif %}
            </div>
        </div>
    </div>
{% endif %}


{# Search Parking Lots Section #}
<div class="card mb-4 shadow-sm" id="search-lot">
    <div class="card-header">
        Find Parking
    </div>
    <div class="card-body">
        <form class="d-flex" method="POST" action="{{ url_for('user.dashboard') }}">
            <input class="form-control me-2" type="search" placeholder="Search by lot name, address, or pin code" aria-label="Search" name="search_term" value="{{ search_term if search_term }}">
            <button class="btn btn-outline-primary" type="submit">Search</button>
        </form>
        <div class="mt-3">
            {% if parking_lots %}
                <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
                    {% for lot in parking_lots %}
                        <div class="col">
                            <div class="card h-100 shadow-sm">
                                <div class="card-body d-flex flex-column">
                                    <h5 class="card-title text-primary">{{ lot.name }}</h5>
                                    <p class="card-text text-muted">{{ lot.address }}, {{ lot.pin_code }}</p>
                                    <p class="card-text">Price: ₹{{ "%.2f"|format(lot.price_per_hour) }} / hour</p>
                                    <p class="card-text">Available Spots: <span class="badge bg-success">{{ lot.spots.filter_by(status='Available').count() }} / {{ lot.maximum_capacity }}</span></p>
                                    <div class="mt-auto"> {# Push button to bottom #}
                                        {% if lot.spots.filter_by(status='Available').count() > 0 %}
                                            <a href="{{ url_for('user.book_spot', lot_id=lot.id) }}" class="btn btn-primary btn-sm">Book Spot</a>
                                        {% else %}
                                            <button class="btn btn-secondary btn-sm" disabled>No Spots Available</button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-muted">No parking lots to display. Try searching or check back later.</p>
            {% endif %}
        </div>
    </div>
</div>

<div class="card mb-4 shadow-sm" id="your-reservations">
    <div class="card-header">
        Your Reservation History
    </div>
    <div class="card-body">
        {% if user_reservations_table %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Lot Name</th>
                            <th>Spot Number</th>
                            <th>Vehicle</th>
                            <th>Booked At</th>
                            <th>Check-in At</th>
                            <th>Left At</th>
                            <th>Status</th>
                            <th>Cost</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for res in user_reservations_table %}
                        <tr>
                            <td>{{ res.id }}</td>
                            <td>
                                {% if res.parking_spot and res.parking_spot.parking_lot %}
                                    {{ res.parking_spot.parking_lot.name }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td>
                                {% if res.parking_spot %}
                                    {{ res.parking_spot.spot_number }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td>{{ res.vehicle_number }}</td>
                            <td>{{ res.booking_timestamp_ist_str }}</td>
                            <td>
                                {% if res.check_in_timestamp_ist_str %}
                                    {{ res.check_in_timestamp_ist_str }}
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if res.check_out_timestamp_ist_str %}
                                    {{ res.check_out_timestamp_ist_str }}
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if res.status == 'pending' %}
                                    <span class="badge bg-warning text-dark">{{ res.status | title }}</span>
                                {% elif res.status == 'active' %}
                                    <span class="badge bg-success">{{ res.status | title }}</span>
                                {% elif res.status == 'completed' %}
                                    <span class="badge bg-info">{{ res.status | title }}</span>
                                {% elif res.status == 'cancelled' %}
                                    <span class="badge bg-danger">{{ res.status | title }}</span>
                                {% else %}
                                    <span class="badge bg-secondary">{{ res.status | title }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if res.total_cost is not none %}
                                    ₹{{ "%.2f"|format(res.total_cost) }}
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td class="text-nowrap">
                                {% if res.status == 'pending' %}
                                    <form action="{{ url_for('user.check_in_reservation', reservation_id=res.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Are you sure you want to check in this spot ?!')">
                                        <button type="submit" class="btn btn-sm btn-success me-1">Check In</button>
                                    </form>
                                    <form action="{{ url_for('user.cancel_reservation', reservation_id=res.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Are you sure you want to cancel this reservation?');">
                                        <button type="submit" class="btn btn-sm btn-danger">Cancel</button>
                                    </form>
                                {% elif res.status == 'active' %}
                                    <a href="{{ url_for('user.park_out_page', reservation_id=res.id) }}" class="btn btn-sm btn-primary">Park Out</a>
                                {% else %}
                                    <span class="text-muted">No Actions</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p class="text-muted">You have no reservations yet.</p>
        {% endif %}
    </div>
</div>

{# User Dashboard Charts Section #}
<div class="card mb-4 shadow-sm">
    <div class="card-header">
        Your Parking Insights
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-header">Parking Cost Trend (Last 10)</div>
                    <div class="card-body d-flex justify-content-center align-items-center">
                        <div class="chart-container">
                            <canvas id="parkingCostChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-header">Parking Frequency (Last 7 Days)</div>
                    <div class="card-body d-flex justify-content-center align-items-center">
                        <div class="chart-container">
                            <canvas id="parkingFrequencyChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 col-md-12 mb-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-header">Most Visited Lots (Last 10)</div>
                    <div class="card-body d-flex justify-content-center align-items-center">
                        <div class="chart-container">
                            <canvas id="mostVisitedLotsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        function createChart(chartId, type, data, options) {
            const ctx = document.getElementById(chartId);
            if (ctx && data && data.labels && data.labels.length > 0) {
                new Chart(ctx, {
                    type: type,
                    data: data,
                    options: options
                });
            } else if (ctx) {
                const parentDiv = ctx.parentElement;
                ctx.remove(); 
                parentDiv.innerHTML = `<div class="alert alert-info text-center mt-3" role="alert">No data available to display this chart yet.</div>`;
                parentDiv.style.display = 'flex';
                parentDiv.style.flexDirection = 'column';
                parentDiv.style.justifyContent = 'center';
                parentDiv.style.alignItems = 'center';
            }
        }

        //Parking Cost 
        const parkingCostRawData = JSON.parse('{{ parking_cost_chart_data|tojson }}');
        
        const parkingCostChartData = {
            labels: parkingCostRawData.map(row => row[0]),
            datasets: [{
                label: 'Parking Cost (₹)',
                data: parkingCostRawData.map(row => row[1]),
                backgroundColor: 'rgba(75, 192, 192, 0.5)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }]
        };

        const parkingCostChartOptions = {
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '₹' + value;
                        }
                    }
                }
            },
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ₹' + context.parsed.y.toFixed(2);
                        }
                    }
                }
            }
        };
        createChart('parkingCostChart', 'line', parkingCostChartData, parkingCostChartOptions);


        //Parking Frequency
        const parkingFrequencyRawData = JSON.parse('{{ parking_frequency_data|tojson }}');

        const parkingFrequencyChartData = {
            labels: parkingFrequencyRawData.map(row => row[0]),
            datasets: [{
                label: 'Parking Count',
                data: parkingFrequencyRawData.map(row => row[1]),
                backgroundColor: 'rgba(153, 102, 255, 0.5)',
                borderColor: 'rgba(153, 102, 255, 1)',
                borderWidth: 1
            }]
        };

        const parkingFrequencyChartOptions = {
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1, 
                        callback: function(value) {
                            if (Number.isInteger(value)) {
                                return value;
                            }
                        }
                    }
                }
            },
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y;
                        }
                    }
                }
            }
        };
        createChart('parkingFrequencyChart', 'bar', parkingFrequencyChartData, parkingFrequencyChartOptions);


        //Most Visited Lots 
        const mostVisitedLotsRawData = JSON.parse('{{ most_visited_lots_data|tojson }}');

        const mostVisitedLotsChartData = {
            labels: mostVisitedLotsRawData.map(row => row[0]),
            datasets: [{
                data: mostVisitedLotsRawData.map(row => row[1]),
                backgroundColor: [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#50C878', '#C0C0C0'
                ],
                hoverOffset: 4
            }]
        };

        const mostVisitedLotsChartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            if (label) label += ': ';
                            if (context.parsed !== null) label += context.parsed;
                            return label;
                        }
                    }
                }
            }
        };
        createChart('mostVisitedLotsChart', 'doughnut', mostVisitedLotsChartData, mostVisitedLotsChartOptions);

    });
</script>
{% endblock %}