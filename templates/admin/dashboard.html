{% extends "base.html" %}

{% block title %}Admin Dashboard - {{ super() }}{% endblock %}

{% block head_css %}
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-2 pb-2 border-bottom">
    <h1 class="h2 text-primary">Admin Dashboard</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('admin.create_parking_lot') }}" class="btn btn-sm btn-outline-primary fs-6">
            <span data-feather="plus-circle" class="align-text-bottom me-1"></span>
            Create New Parking Lot
        </a>
    </div>
</div>

<div class="row">
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3"> 
        <div class="card bg-white text-dark shadow-sm h-100">
            <div class="card-body d-flex flex-column justify-content-between">
                <h5 class="card-title mb-0 text-primary" style="font-size: 0.9rem;">Total Parking Lots</h5> 
                <p class="card-text fs-4 text-dark text-end mt-2">{{ lots|length }}</p>
            </div>
        </div>
    </div>

    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
        <div class="card bg-white text-dark shadow-sm h-100">
            <div class="card-body d-flex flex-column justify-content-between">
                <h5 class="card-title mb-0 text-primary" style="font-size: 0.9rem;">Total Parking Spots</h5>
                <p class="card-text fs-4 text-dark text-end mt-2">{{ total_spots }}</p>
            </div>
        </div>
    </div>
    
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3"> 
        <div class="card bg-white text-dark shadow-sm h-100">
            <div class="card-body d-flex flex-column justify-content-between">
                <h5 class="card-title mb-0 text-success" style="font-size: 0.9rem;">Available Spots</h5>
                <p class="card-text fs-4 text-dark text-end mt-2">{{ available_spots }}</p>
            </div>
        </div>
    </div>
   
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3"> 
        <div class="card bg-white text-dark shadow-sm h-100">
            <div class="card-body d-flex flex-column justify-content-between">
                <h5 class="card-title mb-0 text-danger" style="font-size: 0.9rem;">Occupied Spots</h5>
                <p class="card-text fs-4 text-dark text-end mt-2">{{ occupied_spots }}</p>
            </div>
        </div>
    </div>

    <div class="col-lg-2 col-md-4 col-sm-6 mb-3"> 
        <div class="card bg-white text-dark shadow-sm h-100">
            <div class="card-body d-flex flex-column justify-content-between">
                <h5 class="card-title mb-0 text-info" style="font-size: 0.9rem;">Reserved Spots</h5>
                <p class="card-text fs-4 text-dark text-end mt-2">{{ reserved_spots if reserved_spots is not none else 0 }}</p>
            </div>
        </div>
    </div>
    
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3"> 
        <div class="card bg-white text-dark shadow-sm h-100">
            <div class="card-body d-flex flex-column justify-content-between">
                <h5 class="card-title mb-0 text-primary" style="font-size: 0.9rem;">Registered Users</h5>
                <p class="card-text fs-4 text-dark text-end mt-2">{{ registered_users }}</p>
            </div>
        </div>
    </div>
</div>

<h2 class="mt-4 text-primary">Overview Charts</h2> 
<div class="row mb-4">
    <div class="col-lg-6 col-md-12 mb-3">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Daily Revenue (Last 7 Days)</h5>
            </div>
            <div class="card-body d-flex justify-content-center align-items-center">
                <canvas id="dailyRevenueChart" style="max-height: 250px;"></canvas>
            </div>
        </div>
    </div>

    <div class="col-lg-6 col-md-12 mb-3">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Daily Bookings (Last 7 Days)</h5>
            </div>
            <div class="card-body d-flex justify-content-center align-items-center">
                <canvas id="dailyBookingsChart" style="max-height: 250px;"></canvas>
            </div>
        </div>
    </div>

    <div class="col-lg-4 col-md-6 mb-3">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-primary text-white"> 
                <h5 class="mb-0">Parking Spot Status</h5>
            </div>
            <div class="card-body d-flex justify-content-center align-items-center">
                <canvas id="spotStatusChart" style="max-height: 250px;"></canvas>
            </div>
        </div>
    </div>

    <div class="col-lg-4 col-md-6 mb-3">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-primary text-white"> 
                <h5 class="mb-0">Reservation Status Breakdown</h5>
            </div>
            <div class="card-body d-flex justify-content-center align-items-center">
                <canvas id="reservationStatusChart" style="max-height: 250px;"></canvas>
            </div>
        </div>
    </div>
</div>

<h2 class="mt-4 text-primary">Parking Lot Overview</h2> 
<div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
        <thead>
            <tr>
                <th>Name</th>
                <th>Address</th>
                <th>Capacity</th>
                <th>Occupied</th>
                <th>Reserved</th>
                <th>Available</th>
                <th>Price/Hour</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for lot in lots %}
            <tr>
                <td><a href="{{ url_for('admin.view_lot_spots', lot_id=lot.id) }}" class="text-primary">{{ lot.name }}</a></td> 
                <td>{{ lot.address if lot.address else 'N/A' }}</td>
                <td>{{ lot.maximum_capacity }}</td>
                <td><span class="text-danger fw-bold">{{ lot.spots.filter_by(status='Occupied').count() }}</span></td>
                <td><span class="text-info fw-bold">{{ lot.spots.filter_by(status='Reserved').count() }}</span></td>
                <td><span class="text-success fw-bold">{{ lot.spots.filter_by(status='Available').count() }}</span></td>
                <td>₹{{ "%.2f"|format(lot.price_per_hour) }}</td>
                <td class="text-nowrap">
                    <a href="{{ url_for('admin.edit_parking_lot', lot_id=lot.id) }}" class="btn btn-sm btn-outline-primary me-1">Edit</a>
                    <a href="{{ url_for('admin.view_lot_spots', lot_id=lot.id) }}" class="btn btn-sm btn-outline-primary">View Spots</a>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="8" class="text-center text-muted">No parking lots found. <a href="{{ url_for('admin.create_parking_lot') }}" class="text-primary">Create one now!</a></td> {# Link uses primary accent #}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        function createChart(chartId, type, data, options) {
            const ctx = document.getElementById(chartId);
            if (ctx) {
                const hasData = data.datasets.some(dataset => dataset.data && dataset.data.length > 0 && dataset.data.some(value => value > 0));

                if (hasData) {
                    new Chart(ctx, {
                        type: type,
                        data: data,
                        options: options
                    });
                } else {
                    const parentDiv = ctx.parentElement;
                    ctx.remove(); 
                    parentDiv.innerHTML = `<div class="alert alert-info text-center mt-3" role="alert">No data available to display this chart yet.</div>`;
                    parentDiv.style.display = 'flex';
                    parentDiv.style.flexDirection = 'column';
                    parentDiv.style.justifyContent = 'center';
                    parentDiv.style.alignItems = 'center';
                }
            }
        }

        // Daily Revenue
        const dailyRevenueLabels = JSON.parse('{{ daily_revenue_labels | tojson }}');
        const dailyRevenueAmounts = JSON.parse('{{ daily_revenue_amounts | tojson }}');

        const dailyRevenueData = {
            labels: dailyRevenueLabels,
            datasets: [{
                label: 'Revenue (₹)',
                data: dailyRevenueAmounts,
                borderColor: 'hsl(280, 70%, 55%)', 
                backgroundColor: 'hsla(280, 70%, 55%, 0.2)',
                borderWidth: 2,
                fill: true,
                tension: 0.3
            }]
        };
        const dailyRevenueOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { 
                    display: true, 
                    position: 'top',
                    labels: {
                        color: 'var(--bs-dark)'
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ₹' + context.parsed.y.toFixed(2);
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) { if (Number.isInteger(value)) { return '₹' + value; } else { return '₹' + value.toFixed(2); } },
                        color: 'var(--bs-dark)'
                    },
                    title: {
                        display: true,
                        text: 'Revenue (₹)',
                        color: 'var(--bs-dark)'
                    },
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                },
                x: {
                    ticks: {
                        color: 'var(--bs-dark)'
                    },
                    title: {
                        display: true,
                        text: 'Date',
                        color: 'var(--bs-dark)'
                    },
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                }
            }
        };
        createChart('dailyRevenueChart', 'line', dailyRevenueData, dailyRevenueOptions);

        //Daily Bookings 
        const dailyReservationLabels = JSON.parse('{{ daily_reservation_labels | tojson }}');
        const dailyReservationCounts = JSON.parse('{{ daily_reservation_counts | tojson }}');

        const dailyBookingsData = {
            labels: dailyReservationLabels,
            datasets: [{
                label: 'Bookings',
                data: dailyReservationCounts,
                backgroundColor: 'hsla(210, 70%, 45%, 0.2)', /* Primary accent with transparency */
                borderColor: 'hsl(210, 70%, 45%)',
                borderWidth: 2,
                fill: true,
                tension: 0.3
            }]
        };
        const dailyBookingsOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { 
                    display: true, 
                    position: 'top',
                    labels: {
                        color: 'var(--bs-dark)' 
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) { if (Number.isInteger(value)) { return value; } },
                        color: 'var(--bs-dark)' 
                    },
                    title: {
                        display: true,
                        text: 'Number of Bookings',
                        color: 'var(--bs-dark)'
                    },
                    grid: {
                        color: 'rgba(0,0,0,0.1)' 
                    }
                },
                x: {
                    ticks: {
                        color: 'var(--bs-dark)' 
                    },
                    title: {
                        display: true,
                        text: 'Date',
                        color: 'var(--bs-dark)'
                    },
                    grid: {
                        color: 'rgba(0,0,0,0.1)' 
                    }
                }
            }
        };
        createChart('dailyBookingsChart', 'line', dailyBookingsData, dailyBookingsOptions);

        //Parking Spot Statuses
        const availableSpots = JSON.parse('{{ available_spots | tojson }}');
        const occupiedSpots = JSON.parse('{{ occupied_spots | tojson }}');
        const reservedSpots = JSON.parse('{{ reserved_spots | tojson }}');

        const spotStatusData = {
            labels: ['Available', 'Occupied', 'Reserved'],
            datasets: [{
                data: [availableSpots, occupiedSpots, reservedSpots],
                backgroundColor: [
                    'hsl(140, 60%, 40%)',  
                    'hsl(0, 70%, 50%)',    
                    'hsl(200, 70%, 45%)'    
                ],
                borderColor: '#fff',
                borderWidth: 1
            }]
        };
        const spotStatusOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { 
                    position: 'top',
                    labels: {
                        color: 'var(--bs-dark)' 
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            if (label) label += ': ';
                            if (context.parsed !== null) label += context.parsed + ' spots';
                            return label;
                        }
                    }
                }
            },
            cutout: '70%',
        };
        createChart('spotStatusChart', 'doughnut', spotStatusData, spotStatusOptions);

        // Reservation Status 
        const pendingReservations = JSON.parse('{{ pending_reservations | tojson }}');
        const activeReservations = JSON.parse('{{ active_reservations | tojson }}');
        const completedReservations = JSON.parse('{{ completed_reservations | tojson }}');
        const cancelledReservations = JSON.parse('{{ cancelled_reservations | tojson }}');

        const reservationStatusData = {
            labels: ['Pending', 'Active', 'Completed', 'Cancelled'],
            datasets: [{
                label: 'Number of Reservations',
                data: [pendingReservations, activeReservations, completedReservations, cancelledReservations],
                backgroundColor: [
                    'hsl(200, 70%, 45%)',   
                    'hsl(140, 60%, 40%)',   // success - Green
                    'hsl(210, 10%, 60%)',   
                    'hsl(0, 70%, 50%)'      
                ],
                borderColor: [
                    'hsl(200, 70%, 35%)',
                    'hsl(140, 60%, 30%)',
                    'hsl(210, 10%, 50%)',
                    'hsl(0, 70%, 40%)'
                ],
                borderWidth: 1
            }]
        };
        const reservationStatusOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) { if (Number.isInteger(value)) { return value; } },
                        color: 'var(--bs-dark)' 
                    },
                    grid: {
                        color: 'rgba(0,0,0,0.1)' 
                    }
                },
                x: {
                    ticks: {
                        color: 'var(--bs-dark)' 
                    },
                    grid: {
                        color: 'rgba(0,0,0,0.1)' 
                    }
                }
            }
        };
        createChart('reservationStatusChart', 'bar', reservationStatusData, reservationStatusOptions);
    });
</script>
{% endblock %}
